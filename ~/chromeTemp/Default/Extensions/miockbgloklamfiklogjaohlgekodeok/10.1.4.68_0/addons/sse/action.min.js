(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{800:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var axios=__webpack_require__(98),axios_default=__webpack_require__.n(axios),ServiceFactory=__webpack_require__(1),BrowserService=__webpack_require__(6),defineProperty=(__webpack_require__(19),__webpack_require__(501),__webpack_require__(18),__webpack_require__(61),__webpack_require__(28),__webpack_require__(43),__webpack_require__(69),__webpack_require__(130),__webpack_require__(62),__webpack_require__(20),__webpack_require__(27),__webpack_require__(128),__webpack_require__(50),__webpack_require__(786),__webpack_require__(16),__webpack_require__(32),__webpack_require__(12)),defineProperty_default=__webpack_require__.n(defineProperty),has=__webpack_require__(24),has_default=__webpack_require__.n(has),Consts=__webpack_require__(0),HttpService=__webpack_require__(35),EventsService=__webpack_require__(5),Utils=__webpack_require__(2),FeatureNames=__webpack_require__(46),pureUtils=__webpack_require__(4);function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){defineProperty_default()(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}var sseActions_SecuredService=new class SecuredService_SecuredService{init(options){var that=this;if(this.options=options,!this.pref){this.pref=ServiceFactory.a.get(Consts.Ib),this.newTabUrl=BrowserService.a.getLocalUrl("index.html");var currentSS=this.pref.get("ss"),startObj={urls:{},urls_list:[],urls_whitelist:{},extensions:{},extensions_list:[],tabs:{},activatedTab:{}};"object"!=typeof this.pref.get("ss")?this.pref.set("ss",startObj):this.pref.set("ss",Object.assign(startObj,currentSS))}BrowserService.a.tabsQuery({},tabs=>{var data=that.pref.get(["ss","tabs"]),tabIds=[];for(var i in tabs)tabIds.push(tabs[i].id),tabs[i].active&&that.pref.set(["ss","activatedTab",tabs[i].windowId],tabs[i].id);for(var tabId in data)-1===tabIds.indexOf(parseInt(tabId,10))&&delete data[tabId];that.pref.set(["ss","tabs"],data)}),this.addListeners()}updateConfig(options){this.options?this.options=options:this.init(options)}isWhiteListed(url){var whitelisted=this.pref.get(["ss","urls_whitelist",url]);if(whitelisted||this.options.fullURL||0!==url.indexOf("www.")||(whitelisted=this.pref.get(["ss","urls_whitelist",url.substring(4)])),whitelisted){if("p"===whitelisted||whitelisted>(new Date).getTime())return!0;var whitelist=this.pref.get(["ss","urls_whitelist"]);for(var _url in delete whitelist[url],whitelist)has_default()(whitelist,_url)&&"p"!==whitelist[_url]&&whitelist[_url]>(new Date).getTime()&&delete whitelist[_url];this.pref.set(["ss","urls_whitelist"],whitelist)}return!1}isUrlBlocked(full_url,online){var url=this.url(full_url),whitelisted=this.pref.get(["ss","urls_whitelist",url]);if(whitelisted||this.options.fullURL||0!==url.indexOf("www.")||(whitelisted=this.pref.get(["ss","urls_whitelist",url.substring(4)])),whitelisted){if("p"===whitelisted||whitelisted>(new Date).getTime())return 2;var whitelist=this.pref.get(["ss","urls_whitelist"]);for(var _url in delete whitelist[url],whitelist)has_default()(whitelist,url)&&"p"!==whitelist[_url]&&whitelist[_url]>(new Date).getTime()&&delete whitelist[_url];this.pref.set(["ss","urls_whitelist"],whitelist)}var data=this.getUrlsData([full_url],online);return data[url]&&"ok"!==data[url].status?1:0}url(url){if(this.options.fullURL)return url;var a=document.createElement("a");return a.setAttribute("href",0===url.indexOf("http")?url:`http://${url}`),a.hostname}updateResults(tabId,results){var allResults=this.pref.get(["ss","tabs",tabId,"results"])||{},totalResults=this.pref.get(["ss","tabs",tabId,"totalResults"])||0;for(var url in results)"ok"!==results[url].status&&(allResults[url]=results[url]),totalResults++;return this.pref.set(["ss","tabs",tabId,"results"],allResults),this.pref.set(["ss","tabs",tabId,"totalResults"],totalResults),allResults}addListeners(){var that=this;if(BrowserService.a.onBeforeRequest(details=>{var blocked;if(details.initiator&&details.initiator===BrowserService.a.url().slice(0,-1))return{};if(that.options.securedBrowsing||that.options.securedSearch){if(0===details.frameId&&that.pref.set(["ss","tabs",details.tabId],{url:details.url}),1===(blocked=that.isUrlBlocked(details.url,that.options.securedBrowsing))){if(0===details.frameId)that.pref.set(["ss","tabs",details.tabId,"blocked"],!0),that.pref.set(["ss","tabs",details.tabId,"reason"],that.pref.get(["ss","urls",that.url(details.url),"reason_desc"]));else{var blockedFrames=that.pref.get(["ss","tabs",details.tabId,"blockedFrames"])||[];blockedFrames.push(that.url(details.url)),that.pref.set(["ss","tabs",details.tabId,"blockedFrames"],blockedFrames)}return{redirectUrl:`${that.newTabUrl}?url=${encodeURIComponent(details.url)}#${Object(pureUtils.o)({env:that.options.browserActionWindowId,url:details.url},"-","_")}`}}0===details.frameId&&that.pref.set(["ss","tabs",details.tabId,"blocked"],blocked>0)}return{}},{urls:["<all_urls>"],types:["main_frame","sub_frame"]},["blocking"]),BrowserService.a.onCompleted(details=>{details.url.startsWith(`${that.newTabUrl}#env_${that.options.browserActionWindowId}`)&&-1===details.url.indexOf("hover_1")&&that.updateBrowserAction(!0,details.tabId),-1===details.tabId||that.pref.get(["ss","tabs",details.tabId])||that.pref.set(["ss","tabs",details.tabId],{})},{urls:[that.newTabUrl],types:["main_frame"]}),BrowserService.a.tabsOnActivated(activeInfo=>{that.pref.set(["ss","activatedTab",activeInfo.windowId],activeInfo.tabId)}),BrowserService.a.tabsOnRemoved((tabId,removeInfo)=>{var tabs=that.pref.get(["ss","tabs"]);delete tabs[tabId],that.pref.set(["ss","tabs"],tabs)}),BrowserService.a.tabsOnUpdated((tabId,changeInfo,tab)=>{"complete"===changeInfo.status&&(that.options.securedSearch&&new RegExp(Consts.Gc).test(tab.url)?BrowserService.a.tabsInsertCSS(tabId,{file:"content/scripts/search.css",allFrames:!0},()=>{BrowserService.a.tabsExecuteScript(tabId,{code:`(${function(){return[].slice.call(document.querySelectorAll("li .algo .title a")).map(a=>a.href).concat([].slice.call(document.querySelectorAll('li:not(.first) .compTitle :not(.title) a[referrerpolicy="unsafe-url"]')).map(a=>a.innerText),[].slice.call(document.querySelectorAll("a[class*=domainLink]")).map(a=>a.innerText))}.toString()})();`,runAt:"document_start",allFrames:!0},results=>{var urls=results&&Object(Utils.E)([].concat(...results));urls&&that.getUrlsData(urls,!0,_results=>{var badResults=that.updateResults(tabId,_results);that.updateBrowserAction(!1,tabId,badResults),Object.keys(_results).forEach(url=>{"ok"!==_results[url].status&&that.isWhiteListed(url)&&(_results[url].status="ok")}),BrowserService.a.tabsExecuteScript(tabId,{code:`window["ClqBKCaJtv"] = ${JSON.stringify(_objectSpread({id:BrowserService.a.id(),results:_results,fullURL:that.options.fullURL,tabId:tabId,displayRedShields:!0,displayGreenShields:!0,newTabUrl:that.newTabUrl},that.options.securedSearch))};`,runAt:"document_idle",allFrames:!0},()=>{BrowserService.a.tabsExecuteScript(tabId,{file:"content/scripts/search.js",runAt:"document_idle",allFrames:!0},()=>{})})})})}):that.options.securedBrowsing&&new RegExp("^https?://").test(tab.url)&&BrowserService.a.tabsExecuteScript(tabId,{code:`(${function(){var reg=new RegExp("^https?://");return[].slice.call(document.querySelectorAll("a[href]")).filter(a=>reg.test(a)).map(a=>a.href)}.toString()})();`,runAt:"document_idle",allFrames:!0},results=>{var urls=results&&Object(Utils.E)([].concat(...results).map(that.url.bind(that))).slice(0,that.options.securedBrowsing.scanUrlsAmount||100);urls&&that.getUrlsData(urls,!0,_results=>{_results=that.updateResults(tabId,_results),that.updateBrowserAction(that.pref.get(["ss","tabs",tabId,"blocked"])||!1,tabId,_results)})}),EventsService.a.trigger(Consts.ic,[{tabId:tabId.toString()}])),(that.options.securedSearch&&new RegExp(Consts.Gc).test(tab.url)||that.options.securedBrowsing&&new RegExp("^https?://").test(tab.url))&&that.updateBrowserAction(that.pref.get(["ss","tabs",tab.id,"blocked"]),tab.id)}),EventsService.a.on(Consts.f,args=>{var tabId=parseInt(args.tabId,10);that.pref.set(["ss","urls_whitelist",that.url(args.url)],(new Date).getTime()+(args.ms||18e5)),that.pref.set(["ss","tabs",tabId,"whitelisted"],!0),"updateTab"===args.method?BrowserService.a.updateTab(tabId,args.overrideUrl||args.url):EventsService.a.trigger("REPLACE_LOCATION",{location:args.overrideUrl||args.url},!1,tabId)},!0),EventsService.a.on(Consts.g,args=>{var tabId=parseInt(args.tabId,10);that.pref.set(["ss","urls_whitelist",that.url(args.url)],"p"),that.pref.set(["ss","tabs",tabId,"whitelisted"],!0),"updateTab"===args.method?BrowserService.a.updateTab(tabId,args.overrideUrl||args.url):EventsService.a.trigger("REPLACE_LOCATION",{location:args.overrideUrl||args.url},!1,tabId)},!0),this.options.extensionDefense){var checkExtensions=extensionsInfo=>{that.getExtensionsData(Object.keys(extensionsInfo),results=>{for(var id in results)has_default()(results,id)&&"ok"!==results[id].status&&BrowserService.a.managementSetEnabled(id,!1)})};BrowserService.a.managementGetAll(extensionsInfo=>{var extensions={};extensionsInfo.forEach(extensionInfo=>{extensionInfo.id!==BrowserService.a.id()&&extensionInfo.enabled&&(extensions[extensionInfo.id]=extensionInfo)}),Object.keys(extensions).length>0&&checkExtensions(extensions)}),BrowserService.a.managementOnInstalled(extensionInfo=>{var extensions={};extensions[extensionInfo.id]=extensionInfo,checkExtensions(extensions)}),BrowserService.a.managementOnEnabled(extensionInfo=>{var extensions={};extensions[extensionInfo.id]=extensionInfo,checkExtensions(extensions)})}that.options.securedSearch&&BrowserService.a.tabsQuery({},tabs=>{for(var i in tabs){var tab=tabs[i];new RegExp(Consts.Gc).test(tab.url)&&BrowserService.a.tabsExecuteScript(tab.id,{code:`(${function(){document.querySelectorAll("iframe").forEach(e=>{var clone=e.cloneNode();e.parentNode.appendChild(clone),e.parentNode.removeChild(e)})}.toString()})();`,runAt:"document_start",allFrames:!0},()=>{})}})}updateBrowserAction(blocked,tabId,results){blocked&&BrowserService.a.setBrowserActionIcon("content/images/bsb/icons/icon-red.svg",tabId),results&&Object.keys(results).length>0?(BrowserService.a.setBrowserActionBadgeBackgroundColor("#ff0000",tabId),BrowserService.a.setBrowserActionBadgeText(Object.keys(results).length.toString(),tabId)):BrowserService.a.setBrowserActionBadgeText("",tabId)}getUrlsData(urls,online,cb){return this.getData("urls",urls.map(url=>this.url(url)),online,cb)}getExtensionsData(ids,cb){return this.getData("extensions",ids,!0,cb)}getData(type,keys,online,cb){for(var that=this,list=this.pref.get(["ss",`${type}_list`])||[],missing=[],i=0;i<keys.length;i++){var key=keys[i];if(void 0===this.pref.get(["ss",type,key,"status"]))missing.push(key);else{(new Date).getTime()-(this.pref.get(["ss",type,key,"ts"])||0)>this.options.cacheTimeLimit&&missing.push(key);var ind=list.indexOf(key);-1!==ind&&list.unshift(list.splice(ind,1)[0])}}function handleNewData(newData){if(newData){var _list=that.pref.get(["ss",`${type}_list`]),data=that.pref.get(["ss",type]);for(var _key in newData)has_default()(newData,_key)&&(-1===_list.indexOf(_key)&&_list.unshift(_key)>that.options.cacheSizeLimit&&delete data[_list.pop()],data[_key]=_objectSpread({ts:(new Date).getTime()},newData[_key]));that.pref.set(["ss",`${type}_list`],_list),that.pref.set(["ss",type],data)}}function _getData(){for(var data={},_i=0;_i<keys.length;_i++){var _key2=keys[_i];data[_key2]=that.pref.get(["ss",type,_key2])||{status:"ok"}}return data}if(this.pref.set(["ss",`${type}_list`],list),void 0!==cb){if(online&&missing.length>0){var url=`${this.options[`endpoint_${type}`]}?uid=${that.pref.get(["xlp_pers_guid"])||that.pref.get(["guid"])}`;Object(HttpService.a)({method:"post",url:url,data:missing,featureName:FeatureNames.i}).then(_ref=>{handleNewData(_ref.data),cb(_getData())})}else cb(_getData());return!0}online&&missing.length>0&&handleNewData(HttpService.b.doPostJSON(`${this.options[`endpoint_${type}`]}?uid=${that.pref.get(["xlp_pers_guid"])||that.pref.get(["guid"])}`,missing,null,null,null,null,!1));return _getData()}},verticalConstsLoader=__webpack_require__(155),_getVerticalConsts=Object(verticalConstsLoader.a)("sse"),INIT_NEW_SSE=_getVerticalConsts.INIT_NEW_SSE,INIT_SSE=_getVerticalConsts.INIT_SSE,UPDATE_CONFIG_SSE=_getVerticalConsts.UPDATE_CONFIG_SSE,CHANGE_SSE_STATE=_getVerticalConsts.CHANGE_SSE_STATE;__webpack_exports__.default={[INIT_SSE]:function initSse(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2];var pref=ServiceFactory.a.get(Consts.Ib),active=pref.get("secured_active");if(!0===active||"true"===active){var url=BrowserService.a.getLocalUrl("/lib/background/index.js");axios_default.a.get(url).then(res=>{var script=document.createElement("script");script.setAttribute("src",url),document.head.appendChild(script)})}},[INIT_NEW_SSE]:function initNewSse(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];var behaviour=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};arguments.length>2&&void 0!==arguments[2]&&arguments[2];sseActions_SecuredService.init(behaviour.options)},[UPDATE_CONFIG_SSE]:function updateConfigSse(){arguments.length>0&&void 0!==arguments[0]&&arguments[0];var behaviour=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};arguments.length>2&&void 0!==arguments[2]&&arguments[2];sseActions_SecuredService.updateConfig(behaviour.options)},[CHANGE_SSE_STATE]:function changeSSEState(){arguments.length>0&&void 0!==arguments[0]&&arguments[0],arguments.length>1&&void 0!==arguments[1]&&arguments[1];var self=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if("secured_active"===self.props.config.key){var tracking=ServiceFactory.a.get(Consts.oc),port=BrowserService.a.connectExternalFile("ws_feature_toggle"),prefService=ServiceFactory.a.get(Consts.Ib),active=prefService.get("secured_active");active?port.postMessage({secureSearch:!0}):port.postMessage({secureSearch:!1}),tracking.trackStatusEvent("secured_set","",`active: ${active}`)}}}}}]);