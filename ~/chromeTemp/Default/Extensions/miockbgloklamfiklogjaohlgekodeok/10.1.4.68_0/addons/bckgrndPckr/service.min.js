(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{813:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__(69),__webpack_require__(110),__webpack_require__(16);var moment__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(7),moment__WEBPACK_IMPORTED_MODULE_3___default=__webpack_require__.n(moment__WEBPACK_IMPORTED_MODULE_3__),lodash_get__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(17),lodash_get__WEBPACK_IMPORTED_MODULE_4___default=__webpack_require__.n(lodash_get__WEBPACK_IMPORTED_MODULE_4__),lodash_sample__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(799),lodash_sample__WEBPACK_IMPORTED_MODULE_5___default=__webpack_require__.n(lodash_sample__WEBPACK_IMPORTED_MODULE_5__),_dynamicLoaders_ServiceFactory__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(1),_utils_events_EventsService__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(5),_utils_utils_Consts__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(0),_utils_http_HttpService__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(35),_utils_storage_StorageService__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(31),_dynamicLoaders_verticalConstsLoader__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(155),_actions_components_ActionTypes__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(13),_getVerticalConsts=Object(_dynamicLoaders_verticalConstsLoader__WEBPACK_IMPORTED_MODULE_11__.a)("bckgrndPckr"),USER_WALLPAPERS_LS_KEY=_getVerticalConsts.USER_WALLPAPERS_LS_KEY,USER_SELECTED_BG_IMG_KEY=_getVerticalConsts.USER_SELECTED_BG_IMG_KEY,TOGGLE_USER_WALLPAPERS_LS_KEY=_getVerticalConsts.TOGGLE_USER_WALLPAPERS_LS_KEY,WALLPAPERS_SERVICE=_getVerticalConsts.WALLPAPERS_SERVICE,WALLPAPERS_API=_getVerticalConsts.WALLPAPERS_API,DEFAULT_RANDOM_WALLPAPER_STATE=_getVerticalConsts.DEFAULT_RANDOM_WALLPAPER_STATE;_dynamicLoaders_ServiceFactory__WEBPACK_IMPORTED_MODULE_6__.a.add(class backgroundPickerService{constructor(config){this.config=config,this.wallpaperTimeoutRef=null,_utils_events_EventsService__WEBPACK_IMPORTED_MODULE_7__.a.on(_utils_utils_Consts__WEBPACK_IMPORTED_MODULE_8__.eb,this.getFromCloud.bind(this)),_utils_events_EventsService__WEBPACK_IMPORTED_MODULE_7__.a.on(_utils_utils_Consts__WEBPACK_IMPORTED_MODULE_8__.Bb,this.getFromCloud.bind(this)),_utils_events_EventsService__WEBPACK_IMPORTED_MODULE_7__.a.on(_utils_utils_Consts__WEBPACK_IMPORTED_MODULE_8__.m,this.toggleWallpaper.bind(this)),_utils_events_EventsService__WEBPACK_IMPORTED_MODULE_7__.a.on(_utils_utils_Consts__WEBPACK_IMPORTED_MODULE_8__.y,this.initNewWallpaper.bind(this))}toggleWallpaper(){var userToggleSetting=_utils_storage_StorageService__WEBPACK_IMPORTED_MODULE_10__.a.get(TOGGLE_USER_WALLPAPERS_LS_KEY),randImg=!1;if(userToggleSetting?JSON.parse(userToggleSetting):DEFAULT_RANDOM_WALLPAPER_STATE){var images=this.getLocalWallpapers().images;randImg=lodash_sample__WEBPACK_IMPORTED_MODULE_5___default()(images).url,_utils_storage_StorageService__WEBPACK_IMPORTED_MODULE_10__.a.set(USER_SELECTED_BG_IMG_KEY,randImg)}}initNewWallpaper(event){var tabId=lodash_get__WEBPACK_IMPORTED_MODULE_4___default()(event,"sender.tab.id",!1),image=_utils_storage_StorageService__WEBPACK_IMPORTED_MODULE_10__.a.get(USER_SELECTED_BG_IMG_KEY);_utils_events_EventsService__WEBPACK_IMPORTED_MODULE_7__.a.trigger(_actions_components_ActionTypes__WEBPACK_IMPORTED_MODULE_12__.a,[{image:image,forceCrossContextEvent:!0}],null,tabId)}clearAll(){clearTimeout(this.wallpaperTimeoutRef)}getLocalWallpapers(){var wallpapers=_utils_storage_StorageService__WEBPACK_IMPORTED_MODULE_10__.a.get(USER_WALLPAPERS_LS_KEY);return wallpapers?JSON.parse(wallpapers):{}}wallpapersShouldUpdate(){var now=new Date,localWp=this.getLocalWallpapers();return now>new Date(localWp.update_at||0)}getUserOldWallpapers(){var images=this.getLocalWallpapers().images;if(!images||!Object.keys(images).length)return{};var selectedWallpaperName=_utils_storage_StorageService__WEBPACK_IMPORTED_MODULE_10__.a.get(USER_SELECTED_BG_IMG_KEY).split("/").slice(-1)[0],oldWallpapers={};return images.forEach(wp=>{var wpName=wp.url.split("/").slice(-1)[0];oldWallpapers[wpName]=selectedWallpaperName===wpName}),oldWallpapers}getFromCloud(){if(this.wallpapersShouldUpdate()){var _get2=lodash_get__WEBPACK_IMPORTED_MODULE_4___default()(this.config,"elements.wallpapers",{}),category=_get2.category,updateInDays=_get2.updateInDays,images=this.getUserOldWallpapers(),params={method:"post",url:`${WALLPAPERS_API}/wallpapers`,featureName:WALLPAPERS_SERVICE,data:{category:category,images:images}};Object(_utils_http_HttpService__WEBPACK_IMPORTED_MODULE_9__.a)(params).then(res=>{res.data.update_at=moment__WEBPACK_IMPORTED_MODULE_3___default()().add(updateInDays,"days"),_utils_storage_StorageService__WEBPACK_IMPORTED_MODULE_10__.a.set(USER_WALLPAPERS_LS_KEY,res.data),_utils_storage_StorageService__WEBPACK_IMPORTED_MODULE_10__.a.set(USER_SELECTED_BG_IMG_KEY,res.data.images[0].url),_utils_events_EventsService__WEBPACK_IMPORTED_MODULE_7__.a.trigger(_actions_components_ActionTypes__WEBPACK_IMPORTED_MODULE_12__.a,[{image:res.data.images[0].url,forceCrossContextEvent:!0}]),this.getFromCloud()})}else this.wallpaperTimeoutRef=setTimeout(this.getFromCloud.bind(this),36e5)}},"backgroundPickerService")}}]);